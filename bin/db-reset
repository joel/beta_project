#!/usr/bin/env bash

source ./bin/docker-scripts/init-env

export database_name="beta_project_development"
export container_name="bundle_local_cache_travis_beta_test-db"
export PGPASSWORD=${DB_PASSWORD}

docker exec \
  --env PGPASSWORD=${DB_PASSWORD} \
  ${container_name} bash -c 'echo "postgres password: ${PGPASSWORD}"'

docker exec \
  --env DB_USER=${DB_USER} \
  --env PGPASSWORD=${DB_PASSWORD} \
  --env DATABASE_NAME=${database_name} \
  ${container_name} bash -c 'psql -U ${DB_USER} -c "DROP DATABASE IF EXISTS ${DATABASE_NAME};"'

docker exec \
  --env DB_USER=${DB_USER} \
  --env PGPASSWORD=${DB_PASSWORD} \
  ${container_name} bash -c 'psql -U ${DB_USER} -c "SELECT datname FROM pg_database;"'

docker exec \
  --env DB_USER=${DB_USER} \
  --env PGPASSWORD=${DB_PASSWORD} \
  --env DATABASE_NAME=${database_name} \
  ${container_name} bash -c 'psql -U ${DB_USER} -c "CREATE DATABASE ${DATABASE_NAME};"'

docker exec \
  --env DB_USER=${DB_USER} \
  --env PGPASSWORD=${DB_PASSWORD} \
  ${container_name} bash -c 'psql -U ${DB_USER} -c "SELECT datname FROM pg_database;"'

mkdir -p dumps && cp -rfv db/structure.sql dumps/

docker exec \
  --env DB_USER=${DB_USER} \
  --env PGPASSWORD=${DB_PASSWORD} \
  --env DATABASE_NAME=${database_name} \
  ${container_name} bash -c 'psql -d ${DATABASE_NAME} -U ${DB_USER} -f dumps/structure.sql'

# docker exec \
#   --env DB_USER=${DB_USER} \
#   --env PGPASSWORD=${DB_PASSWORD} \
#   --env DATABASE_NAME=${database_name} \
#   ${container_name} bash -c 'pg_restore -d ${DATABASE_NAME} -U ${DB_USER} -C dumps/structure.sql'


#
#
#
#
# pg_restore -d database_name -U username -C backup.dump
#
# docker exec ${container_name} sh -c "mysql -u ${DB_USER} -p${DB_PASSWORD} ${database_name} < dumps/structure.sql"
#
#
# #
#
# # foo: postgres
# #
# #
# # 'password'; psql -h '127.0.0.1' -U ${DB_USER} -d 'base name' -c 'command'
# #
# # echo "mysql -u ${DB_USER} -p${DB_PASSWORD} -e 'DROP DATABASE IF EXISTS ${database_name};'"
# #
# # # docker exec --env PGPASSWORD=postgres bundle_local_cache_travis_beta_test-db bash -c "psql -U postgres -c 'SELECT datname FROM pg_database;'"
# #
# # docker exec \
# #    --env DB_USER=${DB_USER} \
# #    --env PGPASSWORD=${DB_PASSWORD} \
# #     ${container_name} bash -c "export PGPASSWORD=${DB_PASSWORD}; psql -h '127.0.0.1' -U ${DB_USER} -c 'DROP DATABASE IF EXISTS ${database_name};'"
# #
# # echo "mysql -u ${DB_USER} -p${DB_PASSWORD} -e 'CREATE DATABASE IF NOT EXISTS ${database_name};'"
# #
# # docker exec \
# #   --env DB_USER=${DB_USER} \
# #   --env DB_PASSWORD=${DB_PASSWORD} \
# #     ${container_name} bash -c "mysql -u ${DB_USER} -p${DB_PASSWORD} -e 'CREATE DATABASE IF NOT EXISTS ${database_name};'"
# #
# # echo "mysql -u ${DB_USER} -p${DB_PASSWORD} -e 'CREATE DATABASE IF NOT EXISTS ${database_name};'"
# #
# # cp -rfv db/structure.sql dumps/
# #
# # docker exec ${container_name} sh -c "mysql -u ${DB_USER} -p${DB_PASSWORD} ${database_name} < dumps/structure.sql"
